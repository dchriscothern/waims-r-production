---
title: "WAIMS Daily Readiness"
author: "Athlete Monitoring System"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    theme: flatly
    toc: true
    toc-location: left
    code-fold: true
    css: daily_readiness.css
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
suppressPackageStartupMessages({
  library(DBI)
  library(duckdb)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(knitr)
})

has_kableExtra <- requireNamespace("kableExtra", quietly = TRUE)

kable_safe <- function(df, caption = NULL, digits = NULL) {
  kb <- knitr::kable(df, caption = caption, digits = digits)
  if (has_kableExtra) {
    kb <- kb |>
      kableExtra::kable_styling(
        bootstrap_options = c("striped", "hover"),
        full_width = FALSE
      )
  }
  kb
}

db_path <- file.path("warehouse", "waims.duckdb")
con <- dbConnect(duckdb::duckdb(), db_path, read_only = TRUE)
on.exit(try(dbDisconnect(con, shutdown = TRUE), silent = TRUE), add = TRUE)

tables <- dbListTables(con)

safe_table <- function(tbl) {
  if (!tbl %in% tables) return(NULL)
  dbGetQuery(con, paste0("SELECT * FROM ", tbl))
}

wellness_all  <- safe_table("wellness")
acwr_all      <- safe_table("acwr")
readiness_all <- safe_table("readiness_scores")

if (is.null(wellness_all) || nrow(wellness_all) == 0) {
  stop("Missing or empty table: wellness. Check your ETL pipeline and DuckDB warehouse.")
}
if (!"date" %in% names(wellness_all)) stop("Table wellness must include a 'date' column.")

wellness_all <- wellness_all %>% mutate(date = as.Date(date))
latest_date <- max(wellness_all$date, na.rm = TRUE)

latest_wellness <- wellness_all %>%
  filter(date == latest_date) %>%
  mutate(
    athlete_id  = if ("athlete_id" %in% names(.)) athlete_id else NA,
    position    = if ("position" %in% names(.)) position else NA,
    sleep_hours = if ("sleep_hours" %in% names(.)) as.numeric(sleep_hours) else NA_real_,
    soreness    = if ("soreness" %in% names(.)) as.numeric(soreness) else NA_real_,
    stress      = if ("stress" %in% names(.)) as.numeric(stress) else NA_real_,
    mood        = if ("mood" %in% names(.)) as.numeric(mood) else NA_real_
  )

latest_acwr <- NULL
if (!is.null(acwr_all) && nrow(acwr_all) > 0 && "date" %in% names(acwr_all)) {
  acwr_all <- acwr_all %>% mutate(date = as.Date(date))
  latest_acwr <- acwr_all %>%
    filter(date == max(date, na.rm = TRUE)) %>%
    mutate(
      athlete_id = if ("athlete_id" %in% names(.)) athlete_id else NA,
      acwr       = if ("acwr" %in% names(.)) as.numeric(acwr) else NA_real_
    ) %>%
    select(athlete_id, acwr)
}

if (is.null(latest_acwr)) {
  latest_acwr <- tibble(athlete_id = latest_wellness$athlete_id, acwr = NA_real_)
}

risk_df <- latest_wellness %>%
  left_join(latest_acwr, by = "athlete_id") %>%
  mutate(
    sleep_flag    = !is.na(sleep_hours) & sleep_hours < 6.5,
    soreness_flag = !is.na(soreness) & soreness > 7,
    stress_flag   = !is.na(stress) & stress > 7,
    acwr_flag     = !is.na(acwr) & acwr > 1.5
  )

poor_sleepers <- risk_df %>%
  filter(sleep_flag) %>%
  select(athlete_id, position, sleep_hours, soreness, stress) %>%
  arrange(sleep_hours)

high_risk <- risk_df %>%
  filter(sleep_flag | soreness_flag | stress_flag | acwr_flag) %>%
  mutate(
    risk_factors = paste(
      ifelse(sleep_flag, "Sleep", ""),
      ifelse(soreness_flag, "Soreness", ""),
      ifelse(stress_flag, "Stress", ""),
      ifelse(acwr_flag, "ACWR", ""),
      sep = ", "
    ) |>
      gsub(",\\s*,", ",", _) |>
      gsub("^,\\s*|,\\s*$", "", _)
  ) %>%
  select(athlete_id, position, sleep_hours, soreness, stress, acwr, risk_factors) %>%
  arrange(desc(acwr))

if (!is.null(readiness_all) && nrow(readiness_all) > 0 &&
    all(c("athlete_id","readiness_score") %in% names(readiness_all))) {
  readiness_all <- readiness_all %>% mutate(date = as.Date(date))
  latest_readiness <- readiness_all %>%
    filter(date == max(date, na.rm = TRUE)) %>%
    select(athlete_id, readiness_score) %>%
    mutate(readiness_score = as.numeric(readiness_score))
} else {
  latest_readiness <- latest_wellness %>%
    mutate(
      readiness_score =
        (pmin(pmax(sleep_hours, 0), 10) / 8 * 30) +
        ((10 - pmin(pmax(soreness, 0), 10)) / 10 * 30) +
        ((10 - pmin(pmax(stress, 0), 10)) / 10 * 25) +
        (pmin(pmax(mood, 0), 10) / 10 * 15)
    ) %>%
    select(athlete_id, readiness_score) %>%
    mutate(readiness_score = as.numeric(readiness_score))
}

readiness <- latest_readiness %>%
  mutate(
    status = case_when(
      readiness_score >= 80 ~ "Ready",
      readiness_score >= 60 ~ "Monitor",
      TRUE ~ "At Risk"
    )
  ) %>%
  arrange(readiness_score)

total_athletes <- nrow(latest_wellness)
avg_sleep <- round(mean(latest_wellness$sleep_hours, na.rm = TRUE), 1)
poor_sleep_count <- nrow(poor_sleepers)
high_risk_count  <- nrow(high_risk)

ready_n   <- sum(readiness$status == "Ready", na.rm = TRUE)
monitor_n <- sum(readiness$status == "Monitor", na.rm = TRUE)
risk_n    <- sum(readiness$status == "At Risk", na.rm = TRUE)
```

## Executive Summary

**Report Date:** `r format(latest_date, "%B %d, %Y")`  
**Athletes Monitored:** `r total_athletes`  
**Average Sleep:** `r avg_sleep` hours  
**Poor Sleep Flags:** `r poor_sleep_count`  
**High Risk Flags:** `r high_risk_count`  

## Quick Insights {.panel-tabset}

### Sleep Alert

```{r}
if (poor_sleep_count > 0) {
  cat("Poor sleep flags today:", poor_sleep_count, "\n\n")
  kable_safe(
    poor_sleepers,
    caption = "Athletes with Sleep < 6.5 hours",
    digits = 1
  )
} else {
  cat("All athletes reported at least 6.5 hours of sleep.")
}
```

### High Risk

```{r}
if (high_risk_count > 0) {
  cat("Athletes with one or more risk flags:", high_risk_count, "\n\n")
  kable_safe(
    high_risk,
    caption = "High Risk Flags (Sleep, Soreness, Stress, ACWR)",
    digits = 2
  )
} else {
  cat("No elevated risk flags based on current thresholds.")
}
```

### Readiness

```{r}
cat("Team readiness summary\n\n")
cat("Ready:", ready_n, "  Monitor:", monitor_n, "  At Risk:", risk_n, "\n\n")

kable_safe(
  readiness,
  caption = "Daily Readiness Scores",
  digits = 1
)
```

## Optional Trends

```{r}
wellness_14d <- wellness_all %>%
  filter(date >= (latest_date - 13)) %>%
  arrange(date) %>%
  mutate(
    sleep_hours = if ("sleep_hours" %in% names(.)) as.numeric(sleep_hours) else NA_real_,
    soreness    = if ("soreness" %in% names(.)) as.numeric(soreness) else NA_real_
  )

ggplot(wellness_14d, aes(x = date, y = sleep_hours, group = athlete_id)) +
  geom_line(alpha = 0.25) +
  geom_smooth(aes(group = 1), method = "loess", se = TRUE, color = "#2E86AB") +
  geom_hline(yintercept = 7, linetype = "dashed", color = "orange") +
  geom_hline(yintercept = 8, linetype = "dashed", color = "darkgreen") +
  labs(title = "Sleep Trends (Last 14 Days)", x = NULL, y = "Sleep Hours") +
  theme_minimal()
```