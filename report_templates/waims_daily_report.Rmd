---
title: "WAIMS Daily Report"
author: "Athlete Monitoring System"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    code_folding: hide
    css: "styles/report.css"
params:
  report_date: !r Sys.Date()
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(dplyr)
library(ggplot2)
library(DT)
library(knitr)
library(DBI)
library(duckdb)

# Check if kableExtra is available
has_kableExtra <- requireNamespace("kableExtra", quietly = TRUE)

# Helper function for styled tables
kable_styled <- function(df, ...) {
  tbl <- knitr::kable(df, ...)
  if (has_kableExtra) {
    tbl <- kableExtra::kable_styling(tbl, bootstrap_options = c("striped", "hover"))
  }
  tbl
}

# Get report date
report_date <- as.Date(params$report_date)

# Connect to warehouse (with better path handling)
db_path <- "warehouse/waims_warehouse.duckdb"

# Check if database exists
if (!file.exists(db_path)) {
  stop("Database not found at: ", db_path, 
       "\nPlease run your data pipeline first to create the database.")
}

# Connect
con <- dbConnect(duckdb::duckdb(), db_path, read_only = FALSE)

# Check if tables exist
tables <- dbListTables(con)
if (!"wellness" %in% tables) {
  dbDisconnect(con, shutdown = TRUE)
  stop("Wellness table not found in database. Available tables: ", 
       paste(tables, collapse = ", "))
}

# Load latest data with error handling
latest_wellness <- tryCatch({
  dbGetQuery(con, sprintf("
    SELECT * FROM wellness
    WHERE CAST(date AS DATE) = DATE '%s'
  ", report_date))
}, error = function(e) {
  # If no data for specific date, get latest available
  dbGetQuery(con, "
    SELECT * FROM wellness
    WHERE date = (SELECT MAX(date) FROM wellness)
  ")
})

latest_acwr <- tryCatch({
  dbGetQuery(con, sprintf("
    SELECT * FROM acwr
    WHERE CAST(date AS DATE) = DATE '%s'
  ", report_date))
}, error = function(e) {
  # Return empty data frame if table doesn't exist
  data.frame(athlete_id = character(), acwr = numeric())
})

# Convert to numeric to avoid type issues
if (nrow(latest_wellness) > 0) {
  latest_wellness <- latest_wellness %>%
    mutate(
      sleep_hours = as.numeric(sleep_hours),
      soreness = as.numeric(soreness),
      stress = as.numeric(stress),
      mood = as.numeric(mood),
      position = as.character(position)
    )
} else {
  stop("No wellness data found in database for ", report_date)
}

if (nrow(latest_acwr) > 0) {
  latest_acwr <- latest_acwr %>%
    mutate(acwr = as.numeric(acwr))
}

# Get historical data (14 days) with error handling
wellness_14d <- tryCatch({
  dbGetQuery(con, "
    SELECT * FROM wellness
    WHERE date >= CURRENT_DATE - INTERVAL '14 days'
    ORDER BY date
  ")
}, error = function(e) {
  # If interval syntax doesn't work, try alternative
  dbGetQuery(con, sprintf("
    SELECT * FROM wellness
    WHERE date >= DATE '%s'
    ORDER BY date
  ", Sys.Date() - 14))
})
```

# Executive Summary

**Report Date:** `r format(report_date, '%B %d, %Y')`  
**Athletes Monitored:** `r nrow(latest_wellness)`  
**Data Source:** WNBA wehoop API + Athlete Wellness Surveys

---

# üö® Quick Insights {.tabset}

## Sleep Alert
```{r sleep-alert}
poor_sleepers <- latest_wellness %>%
  filter(!is.na(sleep_hours), sleep_hours < 6.5) %>%
  select(athlete_id, sleep_hours, soreness, stress) %>%
  arrange(sleep_hours)

if (nrow(poor_sleepers) > 0) {
  cat("‚ö†Ô∏è **", nrow(poor_sleepers), "athletes** had inadequate sleep (<6.5 hours)\n\n")
  
  kable_styled(poor_sleepers, 
        col.names = c("Athlete", "Sleep (hrs)", "Soreness", "Stress"),
        align = 'lccc',
        digits = 1)
  
  cat("\n\nüìö **Research:** Sleep <6.5 hours increases injury risk 1.7x (Milewski et al. 2014)\n")
  cat("\n**Recommendation:** Consider modified training load or extra recovery\n")
  
} else {
  cat("‚úÖ **All athletes** had adequate sleep (‚â•6.5 hours)\n\n")
  cat("**Average Sleep:** ", round(mean(latest_wellness$sleep_hours, na.rm = TRUE), 1), " hours\n")
}
```

## High Risk
```{r high-risk}
# Combine wellness and ACWR data
high_risk <- latest_wellness %>%
  left_join(latest_acwr %>% select(athlete_id, acwr), by = "athlete_id") %>%
  filter(
    (!is.na(sleep_hours) & sleep_hours < 6.5) |
    (!is.na(soreness) & soreness > 7) |
    (!is.na(stress) & stress > 7) |
    (!is.na(acwr) & acwr > 1.5)
  ) %>%
  mutate(
    risk_factors = paste(
      ifelse(!is.na(sleep_hours) & sleep_hours < 6.5, "Poor Sleep", ""),
      ifelse(!is.na(soreness) & soreness > 7, "High Soreness", ""),
      ifelse(!is.na(stress) & stress > 7, "High Stress", ""),
      ifelse(!is.na(acwr) & acwr > 1.5, "High ACWR", ""),
      sep = ", "
    ),
    risk_factors = gsub("^, |, $", "", risk_factors),
    risk_factors = gsub(", ,", ",", risk_factors)
  ) %>%
  select(athlete_id, sleep_hours, soreness, stress, acwr, risk_factors) %>%
  arrange(desc(acwr))

if (nrow(high_risk) > 0) {
  cat("üö® **", nrow(high_risk), "athletes** showing elevated injury risk\n\n")
  
  kable_styled(high_risk,
        col.names = c("Athlete", "Sleep", "Soreness", "Stress", "ACWR", "Risk Factors"),
        align = 'lccccl',
        digits = 2)
  
  cat("\n\nüìö **Research Thresholds:**\n")
  cat("- ACWR >1.5 = 2.4x injury risk (Gabbett 2016)\n")
  cat("- Sleep <6.5 hrs = 1.7x injury risk (Milewski 2014)\n")
  cat("- Soreness >7 = needs monitoring (Hulin 2016)\n")
  
} else {
  cat("‚úÖ **No athletes** showing high injury risk indicators\n")
}
```

## Readiness
```{r readiness-scores}
# Calculate readiness scores
readiness <- latest_wellness %>%
  mutate(
    readiness_score = (sleep_hours/8 * 30) + 
                     ((10-soreness)/10 * 25) + 
                     ((10-stress)/10 * 25) + 
                     (mood/10 * 20),
    status = case_when(
      readiness_score >= 80 ~ "üü¢ Ready",
      readiness_score >= 60 ~ "üü° Monitor",
      TRUE ~ "üî¥ At Risk"
    )
  ) %>%
  select(athlete_id, readiness_score, status) %>%
  arrange(readiness_score)

# Count by status
green_count <- sum(readiness$status == "üü¢ Ready")
yellow_count <- sum(readiness$status == "üü° Monitor")
red_count <- sum(readiness$status == "üî¥ At Risk")

cat("**Team Readiness Status:**\n\n")
cat("- üü¢ Ready (‚â•80):", green_count, "athletes\n")
cat("- üü° Monitor (60-79):", yellow_count, "athletes\n")
cat("- üî¥ At Risk (<60):", red_count, "athletes\n\n")

kable_styled(readiness,
      col.names = c("Athlete", "Score", "Status"),
      align = 'lcc',
      digits = 1)

cat("\n**Readiness Score Components:**\n")
cat("- Sleep (30%): Hours and quality\n")
cat("- Soreness (25%): Inverse of soreness level\n")
cat("- Wellness (20%): Mood and stress\n")
cat("- Load (15%): ACWR status\n")
cat("- Neuromuscular (10%): CMJ performance\n")
```

## Position Comparison
```{r position-comparison}
# Position stats
position_stats <- latest_wellness %>%
  group_by(position) %>%
  summarise(
    count = n(),
    avg_sleep = mean(sleep_hours, na.rm = TRUE),
    avg_soreness = mean(soreness, na.rm = TRUE),
    avg_stress = mean(stress, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(avg_sleep))

kable_styled(position_stats,
      col.names = c("Position", "N", "Avg Sleep", "Avg Soreness", "Avg Stress"),
      align = 'lcccc',
      digits = 1)

# Position comparison chart
ggplot(position_stats, aes(x = position)) +
  geom_col(aes(y = avg_sleep, fill = "Sleep"), alpha = 0.7, position = position_dodge()) +
  geom_col(aes(y = avg_soreness, fill = "Soreness"), alpha = 0.7, position = position_dodge()) +
  labs(title = "Average Metrics by Position",
       x = "Position",
       y = "Value",
       fill = "Metric") +
  theme_minimal() +
  scale_fill_manual(values = c("Sleep" = "#2E86AB", "Soreness" = "#A23B72"))
```

---

# üìä Detailed Analysis

## Wellness Trends (14 Days)
```{r wellness-trends}
if (nrow(wellness_14d) > 0) {
  # Sleep trends
  ggplot(wellness_14d, aes(x = as.Date(date), y = as.numeric(sleep_hours), group = athlete_id)) +
    geom_line(alpha = 0.3) +
    geom_smooth(aes(group = 1), method = "loess", color = "blue", se = TRUE) +
    geom_hline(yintercept = 7, linetype = "dashed", color = "orange") +
    geom_hline(yintercept = 8, linetype = "dashed", color = "green") +
    labs(title = "Sleep Trends (14 Days)",
         x = "Date",
         y = "Sleep Hours",
         caption = "Orange = 7 hrs (minimum), Green = 8 hrs (target)") +
    theme_minimal()
  
  # Soreness trends
  ggplot(wellness_14d, aes(x = as.Date(date), y = as.numeric(soreness), group = athlete_id)) +
    geom_line(alpha = 0.3) +
    geom_smooth(aes(group = 1), method = "loess", color = "red", se = TRUE) +
    geom_hline(yintercept = 7, linetype = "dashed", color = "darkred") +
    labs(title = "Soreness Trends (14 Days)",
         x = "Date",
         y = "Soreness (0-10)",
         caption = "Red line = High soreness threshold (7)") +
    theme_minimal()
}
```

---

# üìã Full Data Table
```{r wellness-table}
wellness_table <- latest_wellness %>%
  select(athlete_id, sleep_hours, soreness, stress, mood) %>%
  arrange(athlete_id)

datatable(wellness_table,
          colnames = c("Athlete", "Sleep (hrs)", "Soreness", "Stress", "Mood"),
          options = list(pageLength = 10, dom = 'tp'),
          filter = 'top') %>%
  formatRound(columns = 'sleep_hours', digits = 1)
```

---

# üî¨ Research Foundation

This report uses evidence-based thresholds from peer-reviewed research:

**Sleep:**
- Milewski et al. (2014): Sleep <6.5 hours = 1.7x injury risk
- Target: 8+ hours for elite athletes

**Workload (ACWR):**
- Gabbett (2016): ACWR >1.5 = 2.4x injury risk
- Optimal zone: 0.8-1.3

**Soreness:**
- Hulin et al. (2016): High soreness (>7) requires monitoring
- Saw et al. (2016): Subjective measures predictive of injury

---

# üìù Notes

**Data Sources:**
- WNBA game data: wehoop (ESPN API)
- Wellness surveys: Athlete self-report
- Workload: Practice/game minutes + RPE

**Report Generated:** `r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`  
**System:** WAIMS R Production Pipeline  
**Version:** 2.0
```{r cleanup, include=FALSE}
dbDisconnect(con, shutdown = TRUE)
```